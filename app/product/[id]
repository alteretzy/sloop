import React from 'react';
import { View, Text, TouchableOpacity, ScrollView } from 'react-native';
import { useLocalSearchParams, useRouter } from 'expo-router';
import { Image } from 'expo-image';
import { GlassView } from '../../components/ui/GlassView';
import { Ionicons } from '@expo/vector-icons';
import { useCartStore } from '../../store/cartStore';
import * as Haptics from 'expo-haptics';
import { LinearGradient } from 'expo-linear-gradient';

export default function ProductDetailScreen() {
  const router = useRouter();
  const { id, title, price, image } = useLocalSearchParams(); // Get data passed from Feed
  const addToCart = useCartStore((state) => state.addItem);

  // Parse price safely (since params are strings)
  const priceValue = parseFloat(price as string) || 0;

  const handleAddToCart = () => {
    Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success);
    
    addToCart({
      id: id as string,
      name: title as string,
      image: image as string,
      // Default Mock Data for the variant (since we don't have a real DB for feed items yet)
      selectedOption: { 
        vendor: 'Amazon', 
        price: priceValue, 
        url: 'https://amazon.com', 
        inStock: true, 
        shippingTime: '2 Days' 
      },
      alternatives: [
        { vendor: 'Amazon', price: priceValue, url: '...', inStock: true, shippingTime: '2 Days' },
        { vendor: 'StockX', price: priceValue + 20, url: '...', inStock: true, shippingTime: 'Verified' },
      ]
    });
    
    router.back(); // Go back to feed after adding
  };

  return (
    <View className="flex-1 bg-black">
      {/* 1. Immersive Background Image */}
      <Image
        source={{ uri: image as string }}
        style={{ width: '100%', height: '65%' }}
        contentFit="cover"
      />
      
      {/* Back Button (Floating) */}
      <TouchableOpacity 
        onPress={() => router.back()} 
        className="absolute top-12 left-6 z-10"
      >
        <GlassView intensity={50} className="p-2 rounded-full">
          <Ionicons name="arrow-back" size={24} color="white" />
        </GlassView>
      </TouchableOpacity>

      {/* 2. The Glass Sheet (Details) */}
      <View className="absolute bottom-0 w-full h-[45%]">
        <GlassView intensity={95} className="flex-1 rounded-t-[40px] p-0 overflow-hidden">
          {/* Content Container */}
          <View className="p-8 flex-1">
            <View className="w-12 h-1 bg-white/20 rounded-full self-center mb-6" />
            
            <View className="flex-row justify-between items-start mb-2">
              <Text className="text-white text-3xl font-bold w-3/4 leading-tight">
                {title}
              </Text>
              <Text className="text-green-400 text-2xl font-bold">
                ${priceValue}
              </Text>
            </View>

            <Text className="text-gray-400 text-sm font-medium uppercase tracking-widest mb-6">
              In Stock â€¢ Amazon Prime
            </Text>

            <ScrollView showsVerticalScrollIndicator={false}>
              <Text className="text-gray-300 leading-6 text-base">
                This is a placeholder description for the {title}. In a production app, 
                you would fetch this text from your backend API using the ID. 
                Sloop ensures you get the best price for this item automatically.
              </Text>
            </ScrollView>
          </View>

          {/* Fixed Bottom Action Bar */}
          <View className="p-6 pt-0">
             <TouchableOpacity 
               onPress={handleAddToCart}
               className="bg-white w-full py-4 rounded-2xl flex-row justify-center items-center shadow-lg active:scale-95 transition-transform"
             >
               <Ionicons name="cart" size={20} color="black" style={{ marginRight: 8 }} />
               <Text className="text-black font-bold text-lg">Add to Cart</Text>
             </TouchableOpacity>
          </View>
        </GlassView>
      </View>
    </View>
  );
}